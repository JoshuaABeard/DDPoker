<?xml version="1.0" encoding="UTF-8"?>
<!--
  =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
  DD Poker - Source Code
  Copyright (c) 2003-2026 Doug Donohoe
  
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  For the full License text, please see the LICENSE.txt file
  in the root directory of this project.
  
  The "DD Poker" and "Donohoe Digital" names and logos, as well as any images, 
  graphics, text, and documentation found in this repository (including but not
  limited to written documentation, website content, and marketing materials) 
  are licensed under the Creative Commons Attribution-NonCommercial-NoDerivatives 
  4.0 International License (CC BY-NC-ND 4.0). You may not use these assets 
  without explicit written permission for any uses not covered by this License.
  For the full License text, please see the LICENSE-CREATIVE-COMMONS.txt file
  in the root directory of this project.
  
  For inquiries regarding commercial licensing of this source code or 
  the use of names, logos, images, text, or other assets, please contact 
  doug [at] donohoe [dot] info.
  =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
-->
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.donohoedigital</groupId>
  <artifactId>all</artifactId>
  <packaging>pom</packaging>
  <version>3.3.0-CommunityEdition</version>
  <name>all</name>

  <modules>
    <module>common</module>
    <module>mail</module>
    <module>gui</module>
    <module>db</module>
    <module>jsp</module>
    <module>server</module>
    <module>udp</module>
    <module>tools</module>
    <module>gamecommon</module>
    <module>gameengine</module>
    <module>gameserver</module>
    <module>gametools</module>
    <module>ddpoker</module>
    <module>pokerengine</module>
    <module>pokergamecore</module>
    <module>pokergameserver</module>
    <module>pokernetwork</module>
    <module>poker</module>
    <module>pokerserver</module>
    <module>api</module>
  </modules>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <log4j2.version>2.25.3</log4j2.version>
    <slf4j.version>2.0.16</slf4j.version>
    <servlet.api.version>6.1.0</servlet.api.version>
    <tomcat.version>11.0.18</tomcat.version>
    <spring.version>6.2.15</spring.version>
    <hibernate.version>6.6.42.Final</hibernate.version>
    <jetty.version>12.1.6</jetty.version>
    <junit.version>4.13.2</junit.version>
    <dependency.classpath.outputFile>target/classpath.txt</dependency.classpath.outputFile>
    <!-- Property for JaCoCo argLine (set by prepare-agent goal) -->
    <argLine></argLine>
  </properties>

  <build>

    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.15.0</version>
        <configuration>
          <source>25</source>
          <target>25</target>
          <fork>true</fork>
          <!-- Enable incremental compilation -->
          <useIncrementalCompilation>true</useIncrementalCompilation>
          <!-- Optimize compiler performance -->
          <compilerArgs>
            <arg>-J-Xms256m</arg>
            <arg>-J-Xmx512m</arg>
          </compilerArgs>
        </configuration>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-dependency-plugin</artifactId>
        <version>3.9.0</version>
        <configuration>
          <outputFile>${dependency.classpath.outputFile}</outputFile>
          <includeScope>runtime</includeScope>
        </configuration>
        <executions>
          <execution>
            <id>build-classpath</id>
            <phase>package</phase>
            <goals>
              <goal>build-classpath</goal>
            </goals>
            <configuration>
              <outputFile>${dependency.classpath.outputFile}</outputFile>
              <includeScope>runtime</includeScope>
            </configuration>
          </execution>
        </executions>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-war-plugin</artifactId>
        <version>3.5.1</version>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.5.2</version>
        <configuration>
          <!-- Parallel execution at class level (thread-safe with proper cleanup) -->
          <parallel>classes</parallel>
          <threadCount>2</threadCount>
          <perCoreThreadCount>true</perCoreThreadCount>
          <!-- Fork once per module (memory efficient) -->
          <forkCount>1</forkCount>
          <reuseForks>true</reuseForks>
          <!-- Memory settings (increased for better performance) -->
          <!-- JVM args for Mockito compatibility with Java 21+ -->
          <argLine>-Xmx1024m -XX:+UseParallelGC -XX:TieredStopAtLevel=1 --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.util=ALL-UNNAMED -Dnet.bytebuddy.experimental=true @{argLine}</argLine>
          <!-- Optimize test execution -->
          <runOrder>hourly</runOrder>
          <trimStackTrace>false</trimStackTrace>
        </configuration>
      </plugin>

      <plugin>
        <groupId>org.jacoco</groupId>
        <artifactId>jacoco-maven-plugin</artifactId>
        <version>0.8.13</version>
        <executions>
          <execution>
            <goals>
              <goal>prepare-agent</goal>
            </goals>
          </execution>
          <!-- Report generation moved to verify phase (run with 'mvn verify' or 'mvn jacoco:report') -->
          <execution>
            <id>report</id>
            <phase>verify</phase>
            <goals>
              <goal>report</goal>
            </goals>
          </execution>
          <execution>
            <id>jacoco-check</id>
            <phase>verify</phase>
            <goals>
              <goal>check</goal>
            </goals>
            <configuration>
              <!-- Global enforcement disabled - use module-specific thresholds -->
              <!-- Each module should define its own baseline in module POM -->
              <rules>
                <rule>
                  <element>BUNDLE</element>
                  <limits>
                    <limit>
                      <counter>INSTRUCTION</counter>
                      <value>COVEREDRATIO</value>
                      <minimum>0.00</minimum>
                    </limit>
                  </limits>
                </rule>
              </rules>
            </configuration>
          </execution>
        </executions>
        <configuration>
          <excludes>
            <exclude>**/*UI.class</exclude>
            <exclude>**/*Display.class</exclude>
            <exclude>**/*Renderer.class</exclude>
            <exclude>**/Main.class</exclude>
            <exclude>**/installer/**</exclude>
          </excludes>
        </configuration>
      </plugin>

      <plugin>
        <groupId>com.diffplug.spotless</groupId>
        <artifactId>spotless-maven-plugin</artifactId>
        <version>2.43.0</version>
        <configuration>
          <java>
            <!-- Use current codebase formatting as baseline -->
            <eclipse>
              <version>4.21</version>
            </eclipse>
            <!-- Standard formatting rules -->
            <removeUnusedImports/>
            <trimTrailingWhitespace/>
            <endWithNewline/>
            <!-- Preserve existing indentation style (4 spaces, not tabs) -->
            <indent>
              <spaces>true</spaces>
              <spacesPerTab>4</spacesPerTab>
            </indent>
            <!-- Exclude generated/legacy files from formatting -->
            <excludes>
              <exclude>**/generated/**/*.java</exclude>
              <exclude>**/proto/**/*.java</exclude>
            </excludes>
          </java>
          <!-- POM formatting disabled - too noisy for existing codebase -->
          <!-- <pom>
            <sortPom>
              <expandEmptyElements>false</expandEmptyElements>
              <nrOfIndentSpace>2</nrOfIndentSpace>
            </sortPom>
          </pom> -->
        </configuration>
        <executions>
          <!-- Auto-format on compile -->
          <execution>
            <id>spotless-apply</id>
            <phase>process-sources</phase>
            <goals>
              <goal>apply</goal>
            </goals>
          </execution>
        </executions>
      </plugin>

    </plugins>

    <resources>
      <resource>
        <filtering>false</filtering>
        <directory>${basedir}/src/main/java</directory>
        <includes>
          <include>**/*</include>
        </includes>
        <excludes>
          <exclude>**/*.java</exclude>
        </excludes>
      </resource>
      <resource>
        <filtering>false</filtering>
        <directory>${basedir}/src/main/resources</directory>
        <includes>
          <include>**/*</include>
        </includes>
        <excludes>
          <exclude>**/*.java</exclude>
        </excludes>
      </resource>
    </resources>

    <testResources>
      <testResource>
        <filtering>false</filtering>
        <directory>${basedir}/src/test/java</directory>
        <includes>
          <include>**/*</include>
        </includes>
        <excludes>
          <exclude>**/*.java</exclude>
        </excludes>
      </testResource>
      <testResource>
        <filtering>false</filtering>
        <directory>${basedir}/src/test/resources</directory>
        <includes>
          <include>**/*</include>
        </includes>
        <excludes>
          <exclude>**/*.java</exclude>
        </excludes>
      </testResource>
    </testResources>

  </build>

  <profiles>
    <!-- Fast build profile - skip coverage and integration tests -->
    <profile>
      <id>fast</id>
      <properties>
        <jacoco.skip>true</jacoco.skip>
        <skipITs>true</skipITs>
        <maven.javadoc.skip>true</maven.javadoc.skip>
        <maven.source.skip>true</maven.source.skip>
      </properties>
      <build>
        <plugins>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <configuration>
              <excludedGroups>integration</excludedGroups>
              <!-- Use more aggressive parallelism in fast mode -->
              <threadCount>4</threadCount>
            </configuration>
          </plugin>
        </plugins>
      </build>
    </profile>

    <!-- Dev profile - unit tests only, maximum speed -->
    <profile>
      <id>dev</id>
      <properties>
        <jacoco.skip>true</jacoco.skip>
        <maven.javadoc.skip>true</maven.javadoc.skip>
        <maven.source.skip>true</maven.source.skip>
      </properties>
      <build>
        <plugins>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <configuration>
              <!-- Skip slow and integration tests -->
              <excludedGroups>slow,integration</excludedGroups>
              <!-- Maximum parallelism for dev builds -->
              <threadCount>4</threadCount>
              <!-- Fail fast -->
              <skipAfterFailureCount>1</skipAfterFailureCount>
            </configuration>
          </plugin>
        </plugins>
      </build>
    </profile>

    <!-- Full coverage profile - for CI/CD -->
    <profile>
      <id>coverage</id>
      <activation>
        <activeByDefault>false</activeByDefault>
      </activation>
      <build>
        <plugins>
          <plugin>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <executions>
              <execution>
                <id>report-aggregate</id>
                <phase>verify</phase>
                <goals>
                  <goal>report-aggregate</goal>
                </goals>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
  </profiles>

</project>
